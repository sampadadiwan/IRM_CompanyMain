# PR: US Production Deployment Updates — 2025-10-19

## **1. Overview**
This pull request updates production deployment configurations and infrastructure automation for the US environment.

## **2. Motivation**
These changes ensure that deployment scripts, crontabs, and credentials are aligned with the updated production servers, persistent cron setup for Docker containers, and improved maintainability.

## **3. What Changed**
- **Configuration**
  - Updated `config/deploy/production_us.rb`:
    - New server IPs (`54.147.171.162` & `13.217.203.38`).
    - Switched SSH keys from `caphive2.pem` to `caphive2.us.pem`.
  - Updated `config/credentials/production.us.yml.enc` for new encrypted credentials.
  - Refined roles assignment logic for production app/web instances.
- **Packer Templates**
  - In `config/deploy/templates/packer/appserver.ami.pkr.hcl`:
    - Replaced generic Oh My Zsh install command with explicit steps installing Zsh for ubuntu user and setting default shell.
  - In `config/deploy/templates/packer/db_redis_es.ami.pkr.hcl`:
    - Improved cron persistence setup by using ubuntu's user crontab to run Docker containers (Redis, Elasticsearch) on reboot with verification logging.
- **Rails Configuration**
  - Adjusted `config/schedule.rb`:
    - Ensured AMI creation rake tasks include explicit role assignment to `[:primary]`.
    - Normalized yearly backup job scheduling consistency.
- **App**
  - Minor frontend CSS selector adjustment in `app/assets/stylesheets/custom/scaffolds.scss` to include `#expression_of_interests.dataTable`.
  - Adjusted Rails model hook in `app/packs/core/folders/models/concerns/with_data_room.rb` — changed `after_create_commit` to `after_create` (to trigger data room creation earlier).

## **4. Refactoring / Behavior Changes**
- Crontab logic updated to execute under **ubuntu user scope**; improves persistence across reboots.
- Simplified Rails callback timing for folder creation consistency.
- SSH and host configuration modernization for new environment instance mapping.

## **5. Testing**
- **Manual validation:**
  - Verified AMI creation schedule executes correctly with new role tags.
  - Confirmed cron jobs persist across restarts.
- **Infrastructure tests:**
  - Successful deployment in staging prior to production push.
- **Smoke tests:** Confirmed UI rendering and model hooks post-deployment.

## **6. Impact**
- **Deployment:** New production instances and SSH keys are now active.
- **Infrastructure:** Improved reliability of Docker container persistence on reboot.
- **Codebase:** Minor behavioral improvement on folder creation callbacks — potential quicker resource availability.
- **Compatibility:** Backward-compatible with existing infrastructure automation scripts.

## **7. Review Focus**
- Verify new server IPs and SSH key correctness in `production_us.rb`.
- Double-check encrypted credentials (ensure correct key available in vault).
- Confirm new crontab commands execute as expected under ubuntu's environment.
- Review changed `after_create` timing to ensure no race conditions introduced.
