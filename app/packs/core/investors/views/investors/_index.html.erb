<%
  lazy_load_data ||= false
  import_upload_id ||= params[:import_upload_id]
  title ||= params[:title]
  data_source ||= investors_path(params: params.to_unsafe_h, import_upload_id:, format: :json, all: true)
%>


<div class="d-sm-flex align-items-center justify-content-between mb-4">
  <% header = defined?(title) ? title : "Stakeholders" %>

  <h1 class="h3 mb-0 text-gray-800">
    <%= header %>
  </h1>

  <div class="d-flex flex-wrap align-items-center gap-2 ms-auto">

    <% investor = Investor.new(entity_id: current_user.entity_id) %>

    <% if policy(investor).new? %>
      <%= link_to new_investor_path("investor[entity_id]": current_user.entity_id),
                  class: "btn btn-outline-primary d-inline-flex align-items-center",
                  data: { turbo: false } do %>
        <i class="ti ti-user-plus"></i> New
      <% end %>
    <% end %>

    <%= link_to notes_path,
                class: "btn btn-outline-success d-inline-flex align-items-center",
                data: { turbo: false } do %>
      <i class="ti ti-notes"></i> All Notes
    <% end %>

    <div class="btn-group">
      <div class="dropdown">
        <button class="btn btn-outline-primary dropdown-toggle d-inline-flex align-items-center" type="button"
                data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          <i class="ti ti-settings"></i> <%= t_common(:actions) %>
        </button>

        <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">

          <%= link_to download_xl_link(data_source),
                      class: "dropdown-item d-flex align-items-center",
                      data: { turbo: false } do %>
            <i class="ti ti-download"></i> <%= t_common(:download) %>
          <% end %>

          <% if policy(investor).upload? %>
            <%= link_to new_import_upload_path(
                          "import_upload[import_type]": "Investor",
                          "sample_upload": "INVESTORS_SAMPLE"),
                        class: "dropdown-item d-flex align-items-center",
                        data: { turbo: false } do %>
              <i class="ti ti-upload"></i> <%= t_common(:upload) %>
            <% end %>
          <% end %>

          <div class="dropdown-divider"></div>

          <%= link_to portfolio_reports_path,
                      class: "dropdown-item d-flex align-items-center",
                      data: { turbo: false } do %>
            <i class="ti ti-file-report"></i> Portfolio Reports Setup
          <% end %>

          <%= link_to portfolio_investments_report_all_investors_path(all: true),
                      class: "dropdown-item d-flex align-items-center",
                      data: { turbo: false } do %>
            <i class="ti ti-file-text"></i> Portfolio Investment Report
          <% end %>

          <%= link_to new_investor_notice_path(
                        "investor_notice[owner_id]": current_user.entity_id,
                        "investor_notice[owner_type]": "Entity"),
                      class: "dropdown-item d-flex align-items-center",
                      data: { turbo: false } do %>
            <i class="ti ti-bell-plus"></i> Add Stakeholder Notice
          <% end %>


          <div class="dropdown-divider"></div>

          <%= link_to "Portfolio Company Agent: Completed",
                            investors_path(filter: true, support_agent_report: true, q: ransack_query_params("support_agent_report_status", :eq, "Completed")),
                            class: "dropdown-item d-flex align-items-center ti ti-robot" if current_user.entity.support_agents.set?(:kyc_onboarding_agent) %>

              <%= link_to "Portfolio Company  Agent: Failed",
                            investors_path(filter: true, support_agent_report: true, q: ransack_query_params("support_agent_report_status", :eq, "Failed")),
                            class: "dropdown-item d-flex align-items-center ti ti-robot" if current_user.entity.support_agents.set?(:kyc_onboarding_agent) %>


        </div>
      </div>
    </div>

  </div>

</div>

<%
  investors_frame = "investors_frame"
  default_columns_map = if params["support_agent_report"].present?
                          Investor::PC_AGENT_REPORT_COLUMNS
                        else
                          Investor::STANDARD_COLUMNS
                        end

%>
<%=render SearchComponent.new(data_source: investors_path( params: params.to_unsafe_h, import_upload_id:), turbo_frame: investors_frame) %>
<div class="table-responsive">
  <%= render RansackTable.new(Investor, q: @q, default_columns_map:, entity: current_user.entity, current_user: current_user, report_id: params["report_id"], records: @investors, turbo_frame: investors_frame, referrer: request.referrer, pagy: @pagy) %>
</div>
