<%= turbo_stream_from @faq_thread %>

<div class="container-fluid d-flex flex-column" data-controller="faq-thread" style="padding-left: 0; padding-right: 0;">
  <div class="row flex-grow-1 g-0">
    <!-- Sidebar -->
    <div class="col-md-3 border-end d-none d-md-flex flex-column">

      <div class="flex-grow-1 overflow-auto p-2">
        <div class="list-group list-group-flush">
          <%= button_to "New Chat", faq_threads_path, class: "btn btn-outline-primary w-100 mb-4" %>
          <% @faq_threads.each do |thread| %>
            <%= link_to faq_thread_path(thread),
                class: "list-group-item list-group-item-action #{'active' if thread == @faq_thread}" do %>
              <div class="d-flex w-100 justify-content-between">
                <span class="text-truncate"><%= thread.title.presence || "New Chat" %></span>
              </div>
              <small class="<%= thread == @faq_thread ? 'text-white-50' : 'text-muted' %>">
                <%= time_ago_in_words(thread.updated_at) %> ago
              </small>
            <% end %>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Main Chat Area -->
    <div class="col-md-9 d-flex flex-column">
      <!-- Chat Header -->
      <!-- div class="bg-white border-bottom p-3 shadow-sm sticky-top">
        <h1 class="h5 mb-0"><%= @faq_thread.title.presence || "Support Chat" %></h1>
      </div -->

      <!-- Messages Container -->
      <div id="faq_thread_messages"
           class="flex-grow-1 overflow-auto p-4"
           data-faq-thread-target="messages">
        <!-- Messages will be appended here via Turbo Stream -->
        <% @faq_thread.messages&.each do |msg| %>
          <% # Handle both string keys (from JSON) and symbol keys (if any) %>
          <%= render "faq_threads/message", role: msg["role"] || msg[:role], content: msg["content"] || msg[:content] %>
        <% end %>
      </div>

      <!-- Loading Indicator -->
      <div data-faq-thread-target="typing" class="d-none px-4 py-2 bg-light border-top">
        <div class="spinner-dots">
          <span class="spinner-grow spinner-grow-sm text-secondary" role="status" aria-hidden="true"></span>
          <span class="spinner-grow spinner-grow-sm text-secondary delay-100" role="status" aria-hidden="true"></span>
          <span class="spinner-grow spinner-grow-sm text-secondary delay-200" role="status" aria-hidden="true"></span>
        </div>
      </div>

      <!-- Input Area -->
      <div class="bg-white p-3 border-top">
        <%= form_with url: create_message_faq_thread_path(@faq_thread),
                      method: :post,
                      data: { action: "turbo:submit-end->faq-thread#resetForm" },
                      class: "w-100" do |f| %>
          <div class="input-group">
            <%= f.text_area :message,
                rows: 1,
                placeholder: "Type your message...",
                class: "form-control shadow-none",
                style: "resize: none; max-height: 50px;",
                data: { faq_thread_target: "input", action: "keydown.enter->faq-thread#submitOnEnter" } %>

            <%= button_tag type: "submit", class: "btn btn-primary d-flex align-items-center" do %>
              <i class="fas fa-paper-plane"></i>
            <% end %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<style>
.delay-100 { animation-delay: 0.1s; }
.delay-200 { animation-delay: 0.2s; }
</style>