<% cache [secondary_sale, current_user, current_user.entity_id == secondary_sale.entity_id] do %>
<div class="container-fluid p-3">
  <%= render ToggleCard.new(title: "Secondary Sale: #{secondary_sale.name}", css_class: "show_sale", state: "closed") do %>

  <div class="row">
    <!-- Left Column: Main Info -->
    <div class="col-lg-8">

      <!-- Sale Details -->
      <div class="card shadow-sm border-0 mb-4">
        <div class="card-header border-bottom py-3">
          <h5 class="mb-0 fw-bold"><i class="ti ti-tag me-2 text-primary"></i>Secondary Sale: <%= secondary_sale.name %></h5>
        </div>
        <div class="card-body">
          <div class="row g-4">
            <div class="col-md-6">
              <label class="text-muted text-uppercase fw-bold fs-1 mb-1">Entity</label>
              <div class="fs-4 fw-medium"><%= secondary_sale.entity.name %></div>
            </div>

            <div class="col-md-6">
              <label class="text-muted text-uppercase fw-bold fs-1 mb-1">Support Email</label>
              <div class="fs-4 fw-medium">
                <a href="mailto:<%=secondary_sale.support_email%>" target="_blank" class="text-decoration-none">
                  <%= secondary_sale.support_email %>
                </a>
                <div><span class="badge bg-success">Send your queries here</span></div>
              </div>
            </div>

            <div class="col-md-6">
              <label class="text-muted text-uppercase fw-bold fs-1 mb-1">Name</label>
              <div class="fs-4 fw-medium"><%= secondary_sale.name %></div>
            </div>

            <div class="col-md-6">
              <label class="text-muted text-uppercase fw-bold fs-1 mb-1">Start Date</label>
              <div class="fs-4 fw-medium"><%= l secondary_sale.start_date %></div>
            </div>

            <div class="col-md-6">
              <label class="text-muted text-uppercase fw-bold fs-1 mb-1">Offer End Date</label>
              <div class="fs-4 fw-medium"><%= l secondary_sale.offer_end_date if secondary_sale.offer_end_date %></div>
            </div>

            <div class="col-md-6">
              <label class="text-muted text-uppercase fw-bold fs-1 mb-1">End Date</label>
              <div class="fs-4 fw-medium"><%= l secondary_sale.end_date %></div>
            </div>

            <% if current_user.entity_id == secondary_sale.entity_id %>
              <div class="col-md-6">
                <label class="text-muted text-uppercase fw-bold fs-1 mb-1">Buyer Doc List</label>
                <div class="fs-4 fw-medium"><%= secondary_sale.buyer_doc_list %></div>
              </div>

              <div class="col-md-6">
                <label class="text-muted text-uppercase fw-bold fs-1 mb-1">Seller Doc List</label>
                <div class="fs-4 fw-medium"><%= secondary_sale.seller_doc_list %></div>
              </div>

            <% end %>

            <% if secondary_sale.notification_employee_ids.present? %>
              <% notification_names = secondary_sale.notification_users.map(&:full_name) %>
              <div class="col-12">
                <label class="text-muted text-uppercase fw-bold fs-1 mb-1">Notify Employees</label>
                <div class="fs-4 fw-medium"><%= notification_names %></div>
              </div>
            <% end %>

          </div>
        </div>
      </div>


      <!-- Other Details Card -->
      <% if current_user %>
        <div class="card shadow-sm border-0 mb-4">
          <div class="card-header border-bottom py-3">
            <h5 class="mb-0 fw-bold"><i class="ti ti-settings me-2 text-warning"></i>Other Details</h5>
          </div>
          <div class="card-body">
            <table class="table table-borderless mb-0">
              <%= display_custom_fields(secondary_sale, collapsed: true) %>
            </table>
          </div>
        </div>
      <% end %>

    </div>

    <!-- Right Column: Status -->
    <div class="col-lg-4">

      <!-- Economics -->
      <div class="card shadow-sm border-0 mb-4">
        <div class="card-header border-bottom py-3 px-4">
          <h6 class="mb-0 fw-bold d-flex align-items-center"><i class="ti ti-chart-bar me-2 text-info"></i>Economics</h6>
        </div>
        <div class="card-body">
          <div class="row g-4">
            <% unless policy(secondary_sale).show_interest? %>
              <div class="col-12">
                <label class="text-muted text-uppercase fw-bold fs-1 mb-1">Percent Allowed</label>
                <div class="fs-4 fw-medium"><%= secondary_sale.percent_allowed %> %</div>
              </div>
            <% end %>

            <% if secondary_sale.final_price > 0 %>
              <div class="col-12">
                <label class="text-muted text-uppercase fw-bold fs-1 mb-1">Final Price</label>
                <div class="fs-4 fw-medium"><%= custom_format_number secondary_sale.final_price, params %></div>
              </div>
            <% else %>
              <% if secondary_sale.price_type == "Price Range" %>
                <div class="col-12">
                  <label class="text-muted text-uppercase fw-bold fs-1 mb-1">Price Type</label>
                  <div class="fs-4 fw-medium"><%= secondary_sale.price_type %></div>
                </div>

                <div class="col-12">
                  <label class="text-muted text-uppercase fw-bold fs-1 mb-1">Min Price</label>
                  <div class="fs-4 fw-medium"><%= custom_format_number secondary_sale.min_price, params %></div>
                </div>

                <div class="col-12">
                  <label class="text-muted text-uppercase fw-bold fs-1 mb-1">Max Price</label>
                  <div class="fs-4 fw-medium"><%= custom_format_number secondary_sale.max_price, params %></div>
                </div>
              <% end %>
            <% end %>

            <% if current_user.entity_id == secondary_sale.entity_id %>
              <div class="col-12">
                <label class="text-muted text-uppercase fw-bold fs-1 mb-1">Total Offered</label>
                <div class="fs-4 fw-medium">
                  <%= custom_format_number secondary_sale.display_quantity, params %>
                  <div class="fs-2 text-muted">
                    <% secondary_sale.display_amounts.each_with_index do |amount, idx| %>
                      <%= money_to_currency amount, params %>
                      <%= "-" if idx == 0 && secondary_sale.display_amounts.length > 1 %>
                    <% end %>
                  </div>
                </div>
              </div>

              <div class="col-12">
                <label class="text-muted text-uppercase fw-bold fs-1 mb-1">Actual Offered Quantity</label>
                <div class="fs-4 fw-medium"><%= custom_format_number secondary_sale.total_offered_quantity, params %></div>
              </div>

              <div class="col-12">
                <label class="text-muted text-uppercase fw-bold fs-1 mb-1">Shortlisted Interest Quantity</label>
                <div class="fs-4 fw-medium">
                  <ul class="list-unstyled mb-0">
                    <li>Total: <%= custom_format_number secondary_sale.total_interest_quantity, params %></li>
                    <% price_qty = secondary_sale.interests.short_listed.group(:price).sum(:quantity).sort.to_h %>
                    <% price_qty.each do |price, qty| %>
                      <li class="fs-2 text-muted"><%= qty %> @ <%= price %></li>
                    <% end %>
                  </ul>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      </div>

      <% if current_user.entity_id == secondary_sale.entity_id && secondary_sale.allocation_status.present? %>
        <!-- Allocation Results -->
        <div class="card shadow-sm border-0 mb-4">
          <div class="card-header border-bottom py-3 px-4">
             <h6 class="mb-0 fw-bold d-flex align-items-center"><i class="ti ti-chart-pie me-2 text-success"></i>Allocation Results</h6>
          </div>
          <div class="card-body">
            <div class="row g-4">
              <div class="col-12">
                <label class="text-muted text-uppercase fw-bold fs-1 mb-1">Clearing Price</label>
                <div class="fs-4 fw-medium"><%= custom_format_number secondary_sale.clearing_price, params %></div>
              </div>
              <div class="col-12">
                <label class="text-muted text-uppercase fw-bold fs-1 mb-1">Allocated Quantity</label>
                <div class="fs-4 fw-medium"><%= custom_format_number secondary_sale.allocation_quantity, params %></div>
              </div>
              <div class="col-12">
                <label class="text-muted text-uppercase fw-bold fs-1 mb-1">Allocated Amount</label>
                <div class="fs-4 fw-medium"><%= money_to_currency secondary_sale.allocation_amount, params %></div>
              </div>
            </div>
          </div>
        </div>
      <% end %>

      <!-- Attributes -->
      <div class="card shadow-sm border-0 mb-4">
        <div class="card-header border-bottom py-3 px-4">
          <h6 class="mb-0 fw-bold d-flex align-items-center"><i class="ti ti-list me-2 text-warning"></i>Attributes</h6>
        </div>
        <ul class="list-group list-group-flush">
          <li class="list-group-item d-flex justify-content-between align-items-center py-3 px-4">
            <span class="text-muted">Active</span>
            <span class="fw-bold"><%= display_boolean secondary_sale.active? %></span>
          </li>
        </ul>
      </div>
    </div>

  </div>
  <% end %>
</div>
<% end %>