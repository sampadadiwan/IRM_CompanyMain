<% 
  fund ||= nil 
  import_upload_id ||= params[:import_upload_id]
  title ||= params[:title] || "Account Entries"
%>        

<% 
    data_source ||= account_entries_path(q: params.to_unsafe_h[:q], import_upload_id:, capital_commitment_id: params[:capital_commitment_id], format: :json, all: true, fund_id: params[:fund_id], fund_account_only: params[:fund_account_only])

    xl_link = download_xl_link(data_source) 
    lazy_load_data ||= false 

    col_params = { }
    cols ||= "default"

    if current_user.curr_role == "investor"
      col_params[:column_names] = AccountEntry::INVESTOR_COLUMN_NAMES
      col_params[:column_fields] = AccountEntry::INVESTOR_COLUMN_FIELDS
    else
      col_params[:column_names] = AccountEntry::STANDARD_COLUMN_NAMES
      col_params[:column_fields] = AccountEntry::STANDARD_COLUMN_FIELDS
    end

    if params[:capital_commitment_id].blank?
      col_params[:column_names] = ["Fund", "Investor"] + col_params[:column_names]
      col_params[:column_fields] = ["fund_name", "investor_name"] + col_params[:column_fields]
    end

    column_names, field_list = get_columns(AccountEntry, params: col_params) 
  %>


<div class="table-responsive">

  <div class="d-sm-flex align-items-center justify-content-between mb-4">
    <h1 class="h3 mb-0 text-gray-800"><%= title %></h1>

    <span>  
      <%  
        if params[:capital_commitment_id].present? || params[:fund_id].present?
            account_entry = AccountEntry.new(capital_commitment_id: params[:capital_commitment_id], fund_id: params[:fund_id]) 
            account_entry.entity_id =current_user.entity_id
                
      %>

      
        <%= link_to "New Account Entry", new_account_entry_path("account_entry[capital_commitment_id]": account_entry.capital_commitment_id, "account_entry[entity_id]": account_entry.entity_id, "account_entry[fund_id]": account_entry.fund_id), {class: "btn btn-outline-primary"} if policy(account_entry).new? %>

        <%= link_to "Upload", 
                      new_import_upload_path("import_upload[owner_id]": account_entry.fund_id, 
                      "import_upload[owner_type]": "Fund", 
                      "import_upload[import_type]": "AccountEntry", 
                      "sample_upload": "ACCOUNT_ENTRY_SAMPLE"), 
                      { class: "btn btn-outline-primary"}   %> 


        <%= link_to "Download", xl_link, 
                                class: "btn btn-outline-success" %>

        <%= button_to "Delete Results", delete_all_account_entries_path(fund_id: params[:fund_id], q: params[:q].to_unsafe_h), class: "btn btn-outline-danger", form_class: "deleteButton", data: {action: "click->confirm#popup", turbo:false, msg: "Delete all account entries in search results?", method: :post}  if params[:q].present? %>

      <% else %>
        <%= link_to "Download", xl_link, class: "btn btn-outline-success" %>
        <%= button_to "Delete Results", delete_all_account_entries_path(fund_id: params[:fund_id], q: params[:q].to_unsafe_h), class: "btn btn-outline-danger", form_class: "deleteButton", data: {action: "click->confirm#popup", turbo:false, msg: "Delete all account entries in search results?", method: :post}  if params[:q].present? %>
      <% end %>


      <%= link_to "Filter", account_entries_path(fund_id: params[:fund_id], q: ransack_query_params("capital_commitment_id", :eq, params[:capital_commitment_id])), {class: "btn btn-outline-success" }  %>


    </span>

    
  </div>

  

  <div class="table-responsive" data-controller="account-entries" 
    data-account-entries-lazy-load-data-value=<%= lazy_load_data %> 
    data-account-entries-table-name-value="#account_entries_table"
    data-account-entries-field-list-value=<%=field_list%> >

    <% if lazy_load_data %>
      <a class="load_data_link" data-action="click->account-entries#loadData"><span>Load Data</span></a>
    <% end %>

    <%= render CustomTable.new(data_source:, id: "account_entries_table", column_names:) %>
    
  </div>

</div>
