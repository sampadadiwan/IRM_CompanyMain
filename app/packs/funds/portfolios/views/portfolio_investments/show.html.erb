<div class="container-fluid p-3">
  <%= render ToggleCard.new(title: "#{@portfolio_investment}", css_class: "show_kyc_#{@portfolio_investment.id}", state: "show") do %>
  <div class="row">
    <!-- Left Column: Main Info -->
    <div class="col-lg-8">
      <div class="card shadow-sm border-0 mb-4">
        <div class="card-header  border-bottom py-3">
          <h5 class="mb-0 fw-bold "><i class="ti ti-info-circle me-2 text-primary"></i>Portfolio Investment: <%= @portfolio_investment.portfolio_company_name %></h5>
        </div>
        <div class="card-body">
          <div class="row g-4">
            <div class="col-md-6">
              <label class="text-muted text-uppercase fw-bold fs-1 mb-1">Entity</label>
              <div class="fs-4 fw-medium "><%= @portfolio_investment.entity.name %></div>
            </div>

            <div class="col-md-6">
              <label class="text-muted text-uppercase fw-bold fs-1 mb-1">Fund</label>
              <div class="fs-4"><%= link_to @portfolio_investment.fund, class: "text-decoration-none fw-bold text-primary" %></div>
            </div>

            <div class="col-md-6">
              <label class="text-muted text-uppercase fw-bold fs-1 mb-1">Company Name</label>
              <div class="fs-4"><%= link_to @portfolio_investment.portfolio_company, class: "text-decoration-none fw-bold text-primary" %></div>
            </div>

            <div class="col-md-6">
              <label class="text-muted text-uppercase fw-bold fs-1 mb-1">Instrument</label>
              <div class="fs-4"><%= link_to @portfolio_investment.investment_instrument, class: "text-decoration-none fw-bold text-primary" %></div>
            </div>

            <div class="col-12">
              <label class="text-muted text-uppercase fw-bold fs-1 mb-1">Notes</label>
              <div class="p-3 bg-light rounded border-start border-4 border-primary">
                <%= @portfolio_investment.notes.presence || '<span class="text-muted fst-italic">No notes provided</span>'.html_safe %>
              </div>
            </div>
          </div>
        </div>
      </div>

      <% if current_user %>
        <div class="card shadow-sm border-0 mb-4">
          <div class="card-header  border-bottom py-3">
            <h5 class="mb-0 fw-bold "><i class="ti ti-settings me-2 text-info"></i>Other Details</h5>
          </div>
          <div class="card-body">
             <table class="table table-borderless mb-0">
               <%= display_custom_fields(@portfolio_investment) %>
             </table>
          </div>
        </div>
      <% end %>

    </div>

    <!-- Right Column: Financials, Attributes & Actions -->
    <div class="col-lg-4">

      <!-- Financials -->
      <div class="card shadow-sm border-0 mb-4">
        <div class="card-header  border-bottom py-3">
          <h6 class="mb-0 fw-bold  d-flex align-items-center"><i class="ti ti-chart-pie me-2 text-success"></i>Financials</h6>
        </div>
        <ul class="list-group list-group-flush">
            <li class="list-group-item d-flex justify-content-between align-items-center py-3">
                <span class="text-muted">Investment Date</span>
                <span class="fw-bold "><%= l @portfolio_investment.investment_date if @portfolio_investment.investment_date %></span>
            </li>
            <% if @portfolio_investment.conversion_date %>
                <li class="list-group-item d-flex justify-content-between align-items-center py-3">
                    <span class="text-muted">Conversion Date</span>
                    <span class="fw-bold "><%= l @portfolio_investment.conversion_date %></span>
                </li>
            <% end %>

            <% if @portfolio_investment.base_amount_cents != @portfolio_investment.amount_cents %>
                 <li class="list-group-item d-flex justify-content-between align-items-center py-3">
                    <span class="text-muted">Instrument Currency</span>
                    <span class="fw-bold "><%= @portfolio_investment.investment_instrument.currency.to_s %></span>
                </li>
                 <li class="list-group-item d-flex justify-content-between align-items-center py-3">
                    <span class="text-muted">Base Amount</span>
                    <span class="fw-bold "><%= money_to_currency @portfolio_investment.base_amount, params %></span>
                </li>
            <% end %>

            <li class="list-group-item d-flex justify-content-between align-items-center py-3">
                <span class="text-muted">Amount</span>
                <span class="fw-bold "><%= money_to_currency @portfolio_investment.amount, params %></span>
            </li>

            <% if @portfolio_investment.amount_cents != @portfolio_investment.ex_expenses_amount_cents %>
                 <li class="list-group-item d-flex justify-content-between align-items-center py-3">
                    <span class="text-muted">Amount (Excl. Exp)</span>
                    <span class="fw-bold "><%= money_to_currency @portfolio_investment.ex_expenses_amount, params %></span>
                </li>
            <% end %>

            <% if @portfolio_investment.amount_cents != @portfolio_investment.net_amount_cents %>
                 <li class="list-group-item d-flex justify-content-between align-items-center py-3">
                    <span class="text-muted">Net Amount</span>
                    <span class="fw-bold "><%= money_to_currency @portfolio_investment.net_amount, params %></span>
                </li>
            <% end %>

             <li class="list-group-item d-flex justify-content-between align-items-center py-3">
                <span class="text-muted">Quantity</span>
                <span class="fw-bold "><%= @portfolio_investment.quantity %></span>
            </li>


            <li class="list-group-item d-flex justify-content-between align-items-center py-3">
                <span class="text-muted">Valuation</span>
                <span class="fw-bold "><%= link_to @portfolio_investment.valuation.to_s, valuation_path(@portfolio_investment.valuation), class: "text-decoration-none fw-bold text-primary" if @portfolio_investment.valuation %></span>
            </li>

            <% if @portfolio_investment.buy? %>
                 <li class="list-group-item d-flex justify-content-between align-items-center py-3">
                    <span class="text-muted">Sold Quantity</span>
                    <span class="fw-bold "><%= @portfolio_investment.sold_quantity %></span>
                </li>
                 <li class="list-group-item d-flex justify-content-between align-items-center py-3">
                    <span class="text-muted">Transfer Quantity</span>
                    <span class="fw-bold "><%= @portfolio_investment.transfer_quantity %></span>
                </li>
                 <li class="list-group-item d-flex justify-content-between align-items-center py-3">
                    <span class="text-muted">Transfer Amount</span>
                    <span class="fw-bold "><%= money_to_currency @portfolio_investment.transfer_amount %></span>
                </li>
                 <li class="list-group-item d-flex justify-content-between align-items-center py-3">
                    <span class="text-muted">Net Quantity</span>
                    <span class="fw-bold "><%= @portfolio_investment.net_quantity %></span>
                </li>
                 <li class="list-group-item d-flex justify-content-between align-items-center py-3">
                    <span class="text-muted">Cost of Remaining</span>
                    <span class="fw-bold "><%= @portfolio_investment.cost_of_remaining %></span>
                </li>
                 <li class="list-group-item d-flex justify-content-between align-items-center py-3">
                    <span class="text-muted">Cost Per Share</span>
                    <span class="fw-bold "><%= money_to_currency @portfolio_investment.cost, params %></span>
                </li>
            <% end %>

            <li class="list-group-item d-flex justify-content-between align-items-center py-3">
                <span class="text-muted">FMV</span>
                <span class="fw-bold "><%= money_to_currency @portfolio_investment.fmv, params %></span>
            </li>

             <% if @portfolio_investment.sell? %>
                 <li class="list-group-item d-flex justify-content-between align-items-center py-3">
                    <span class="text-muted">Sale Price/Share</span>
                    <span class="fw-bold "><%= money_to_currency @portfolio_investment.sale_price_per_share, params %></span>
                </li>
                 <li class="list-group-item d-flex justify-content-between align-items-center py-3">
                    <span class="text-muted">Cost of Sold</span>
                    <span class="fw-bold "><%= money_to_currency @portfolio_investment.cost_of_sold, params %></span>
                </li>
                 <li class="list-group-item d-flex justify-content-between align-items-center py-3">
                    <span class="text-muted">Cost of Sold/Share</span>
                    <span class="fw-bold "><%= money_to_currency @portfolio_investment.cost_of_sold_per_share, params %></span>
                </li>
                 <li class="list-group-item d-flex justify-content-between align-items-center py-3">
                    <span class="text-muted">Gain</span>
                    <span class="fw-bold "><%= money_to_currency @portfolio_investment.gain, params %></span>
                </li>
            <% else %>
                 <li class="list-group-item d-flex justify-content-between align-items-center py-3">
                    <span class="text-muted">Unrealized Gain</span>
                    <span class="fw-bold "><%= money_to_currency @portfolio_investment.unrealized_gain, params %></span>
                </li>
            <% end %>

            <% if params[:debug].present? && @portfolio_investment.sell? %>
                 <li class="list-group-item d-flex justify-content-between align-items-center py-3">
                    <span class="text-muted">Cost of Sold (Debug)</span>
                    <span class="fw-bold "><%= money_to_currency @portfolio_investment.cost_of_sold, params %></span>
                </li>
                 <li class="list-group-item d-flex justify-content-between align-items-center py-3">
                    <span class="text-muted">Gain (Debug)</span>
                    <span class="fw-bold "><%= money_to_currency @portfolio_investment.gain, params %></span>
                </li>
            <% end %>
        </ul>
      </div>

      <div class="card shadow-sm border-0 mb-4">
        <div class="card-header  border-bottom py-3">
          <h6 class="mb-0 fw-bold  d-flex align-items-center"><i class="ti ti-list me-2 text-warning"></i>Attributes</h6>
        </div>
        <ul class="list-group list-group-flush">
          <li class="list-group-item d-flex justify-content-between align-items-center py-3">
            <span class="text-muted">Startup</span>
            <%= display_boolean @portfolio_investment.startup %>
          </li>
          <li class="list-group-item d-flex justify-content-between align-items-center py-3">
            <span class="text-muted">Proforma</span>
            <%= display_boolean @portfolio_investment.proforma %>
          </li>
          <% if @portfolio_investment.capital_distribution.present? %>
            <li class="list-group-item d-flex justify-content-between align-items-center py-3">
                <span class="text-muted">Linked Distribution</span>
                <%= link_to "View", @portfolio_investment.capital_distribution %>
            </li>
          <% end %>
        </ul>
      </div>

       <!-- Actions -->
       <% unless @portfolio_investment.snapshot %>
        <div class="card shadow-sm border-0 mb-4">
          <div class="card-header  border-bottom py-3">
            <h6 class="mb-0 fw-bold  d-flex align-items-center"><i class="ti ti-settings me-2 text-secondary"></i>Actions</h6>
          </div>
          <div class="card-body">
             <div class="d-grid gap-2">
                 <% if policy(@portfolio_investment).update? %>
                    <%= link_to edit_portfolio_investment_path(@portfolio_investment), class: "btn btn-outline-primary" do %>
                      <i class="ti ti-edit"></i> <%= t_common(:edit) %>
                    <% end %>

                    <% if policy(@portfolio_investment).conversion? %>
                      <%= link_to new_stock_conversion_path(
                                    "stock_conversion[from_portfolio_investment_id]": @portfolio_investment.id),
                                  class: "btn btn-outline-success" do %>
                        <i class="ti ti-transfer"></i>Conversion
                      <% end %>
                    <% end %>
                  <% end %>

                  <% if policy(@portfolio_investment).destroy? %>
                    <%= button_to @portfolio_investment, method: :delete,
                                class: "btn btn-outline-danger w-100", form_class: "deleteButton",
                                data: { action: "click->confirm#popup", turbo: false } do %>
                      <i class="ti ti-trash"></i> <%= t_common(:delete) %>
                    <% end %>
                  <% end %>
             </div>
          </div>
        </div>
      <% end %>

    </div>
  </div>
  <% end %>
</div>

<!-- Details Partial -->
<div>
    <%= render "portfolio_investments/details", portfolio_investment: @portfolio_investment %>
</div>
