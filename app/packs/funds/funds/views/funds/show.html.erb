<%
commands = [
    ["New Commitment", new_capital_commitment_path("capital_commitment[fund_id]": @fund.id)],
    ["Upload Commitments", new_import_upload_path("import_upload[owner_id]": @fund.id, "import_upload[owner_type]": "Fund", "import_upload[import_type]": "CapitalCommitment")],
    ["Download Commitments", capital_commitments_path(all: true, fund_id: @fund.id, format: :xlsx)]
]

%>
<%= render "funds/hotkeys", commands:, model: @fund %>

<% if current_user.entity_id == @fund.entity_id || current_user.curr_role == "advisor" %>
  <%= render "/funds/fund_stats", fund: @fund %>
<% else %>
  <%= render "/funds/fund_investor_stats", fund: @fund %>
<% end %>

<% if current_user.entity_id == @fund.entity_id || current_user.entity.child_ids.include?(@fund.entity_id) %>
  <%= render "funds/show", fund: @fund %>
<% end %>

  <div>
    <% if policy(@fund).update? %>

      <div class="btn-group">
        <div class="dropdown">
          <button class="btn btn-outline-success dropdown-toggle" type="button"
                  data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            Reports
          </button>
          <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">

            <li class="dropdown-submenu dropend">
                <a href="#" id="basic_reports" data-bs-toggle="dropdown" class="dropdown-item dropdown-toggle">Basic Reports</a>
                <ul class="dropdown-menu">
                    <li>
                        <%= link_to "eSignatures Report" , report_fund_path(@fund, report: "dashboard/e_signatures"), {class: "dropdown-item" } %>
                    </li>
                    <li>
                        <%= link_to "Fund Export" , export_fund_path(@fund), {class: "dropdown-item" } %>
                    </li>
                    <li>
                        <%= link_to "Foreign Remittances" , report_fund_path(@fund, report: "dashboard/foreign_remittances"), {class: "dropdown-item" } %>
                    </li>
                    <li>
                      <%= link_to "Fund Numbers" , report_fund_path(@fund, report: "dashboard/chart"), {class: "dropdown-item" } %>
                    </li>

                    <li>
                      <%= link_to "Dashboard" , dashboard_fund_path(@fund), {class: "dropdown-item" } %>
                    </li>
                    <li>
                      <%= link_to "Pending Remittances" , report_fund_path(@fund, report: "dashboard/calls_report"), {class: "dropdown-item" } %>
                    </li>
                    <li>
                      <%= link_to "Advisor Payouts" , report_fund_path(@fund, report: "dashboard/advisor_payouts"), {class: "dropdown-item" } %>
                    </li>
                </ul>
            </li>

            <div class="dropdown-divider"></div>


            <%= link_to "Dashboard" , dashboard_fund_path(@fund), {class: "dropdown-item" } %>

            <%= link_to "Sign In Report" , report_fund_path(@fund, report: "dashboard/sign_in_count"), {class: "dropdown-item" } %>
            <%= link_to "Onboarding Report" , report_fund_path(@fund, report: "dashboard/onboarding_report", show_docs: true), {class: "dropdown-item" } %>

            <div class="dropdown-divider"></div>
            <%= link_to "Generate Reports" , report_fund_path(@fund, report: "generate_reports"), {class: "dropdown-item" } %>
          </div>
        </div>
      </div>

      <% if @fund.entity.entity_setting.regulatory_env == "SEBI" %>
      <div class="btn-group">
        <div class="dropdown">
          <button class="btn btn-outline-success dropdown-toggle" type="button"
                  data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            Fund Reports
          </button>
          <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
            <%= link_to "Generate Reports", new_fund_report_path(fund_id: @fund.id), {class: "dropdown-item"} if policy(FundReport.new(fund_id: @fund.id, entity_id: @fund.entity_id)).new? %>
            <%= link_to "All Reports", fund_reports_path(fund_id: @fund.id), {class: "dropdown-item" }  %>

            <div class="dropdown-divider"></div>

            <%= link_to "Corpus Details" , fund_reports_path(fund_id: @fund.id, name: "CorpusDetails"), {class: "dropdown-item" } %>
            <%= link_to "Information on Investments" , fund_reports_path(fund_id: @fund.id, name: "InformationOnInvestments" ), {class: "dropdown-item" } %>
            <%= link_to "Info on Stakeholders" , fund_reports_path(fund_id: @fund.id, name: "InfoOnInvestors"), {class: "dropdown-item" } %>
            <%= link_to "Download SEBI Report" , fund_report_path(fund_id: @fund.id, report: "sebi_report"), {class: "dropdown-item" } %>

            <div class="dropdown-divider"></div>

            <%= link_to "Download CRISIL Report" , fund_report_path(fund_id: @fund.id, report: "crisil_report"), {class: "dropdown-item" } %>
          </div>
        </div>
      </div>
      <% end %>

      <% if policy(@fund).update? %>

        <div class="btn-group">
          <div class="dropdown">
            <button class="btn btn-outline-primary dropdown-toggle" type="button"
                    data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              Import
            </button>
            <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
              <%= link_to "Import Account Entries",
                      new_import_upload_path("import_upload[owner_id]": @fund.id,
                      "import_upload[owner_type]": "Fund",
                      "import_upload[import_type]": "AccountEntry",
                      "sample_upload": "ACCOUNT_ENTRY_SAMPLE"),
                      { class: "dropdown-item"}  if @fund.entity.permissions.enable_account_entries? %>


              <%= link_to "Import Documents",
                      new_import_upload_path("import_upload[owner_id]": @fund.id,
                      "import_upload[owner_type]": "Fund",
                      "import_upload[import_type]": "FundDocs",
                      "sample_upload": "FUND_DOCS_SAMPLE"),
                      { class: "dropdown-item"}   %>


              <%= link_to "Import Investor Advisors",
                  new_import_upload_path("import_upload[owner_id]": @fund.id,
                      "import_upload[owner_type]": "Fund",
                      "import_upload[import_type]": "InvestorAdvisor",
                      "sample_upload": "FUND_INVESTOR_ADVISORS_SAMPLE"),
                      { class: "dropdown-item"}  %>

            </div>
          </div>
        </div>

      <% end %>

      <div class="btn-group">
        <div class="dropdown">
          <button class="btn btn-outline-primary dropdown-toggle" type="button"
                  data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            Actions
          </button>
          <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">

            <% if policy(@fund).update? %>

              <%= link_to "Edit Fund" , edit_fund_path(@fund), {class: "dropdown-item" } %>
              <%= button_to "Delete Fund" , @fund, method: :delete, class: "dropdown-item" ,
                  form_class: "deleteButton",
                  data: {action: "click->confirm#popup" , turbo:false} if policy(@fund).destroy? %>

              <%= link_to "Fund Approval" , new_approval_path("approval[owner_id]": @fund.id, "approval[owner_type]": "Fund"), {class: "dropdown-item" } %>

              <% if policy(@fund).run_checks? %>

                <div class="dropdown-divider"></div>
                <%= link_to "Run Compliance Check", run_checks_ai_checks_path(parent_id: @fund.id, parent_type: "Fund", rule_type: "compliance"), class: "dropdown-item" %>

                <%= link_to "View Compliance Check", ai_checks_path(q: ransack_query_params_multiple([[:ai_rule_rule_type, :eq, "compliance"], [:parent_id, :eq, @fund.id], [:parent_type, :eq, "Fund"] ])), class: "dropdown-item" %>

              <% end %>

            <% end %>

            <% if @fund.entity.permissions.enable_account_entries? %>

              <div class="dropdown-divider"></div>


              <li class="dropdown-submenu dropend">
                <a href="#" id="basic_reports" data-bs-toggle="dropdown" class="dropdown-item dropdown-toggle">Account Entries</a>
                <ul class="dropdown-menu">
                    <li>
                        <%= link_to "Fund Account Entries", account_entries_path(fund_id: @fund.id, fund_accounts_only: true, all: true), class: "dropdown-item" %>
                    </li>
                    <li>
                        <%= link_to "Allocation Formulas" , fund_formulas_path(fund_id: @fund.id), {class: "dropdown-item" } %>
                    </li>
                    <li>
                        <%= link_to "Allocate Account Entries", allocate_form_fund_path(@fund, run_allocations: true), class: "dropdown-item" if policy(@fund).allocate? %>
                    </li>
                </ul>
              </li>

            <% end %>

            <% if policy(@fund).update? %>
              <%
              document = Document.new(entity_id: @fund.entity_id , owner: @fund)
              doc_attributes = document.attributes.delete_if{|k,v| !["entity_id", "owner_id", "owner_type"].include?(k)}
              %>

              <div class="d-none d-sm-block">
                <li class="dropdown-submenu dropend">
                  <a href="#" id="misc_action_menu" data-bs-toggle="dropdown" class="dropdown-item dropdown-toggle">Misc</a>
                  <ul class="dropdown-menu">
                      <li>
                          <%= link_to "New Template", new_document_path(document: doc_attributes, "document[folder_id]": @fund.document_folder.id), {class: "dropdown-item"} %>
                      </li>
                      <li>
                          <%= link_to "Add Investor Notice" , new_investor_notice_path( "investor_notice[owner_id]": @fund.id, "investor_notice[owner_type]": "Fund"), {class: "dropdown-item" }  %>
                      </li>
                      <li>
                          <%= link_to 'Send Email', "mailto:?bcc=#{@fund.get_lps_emails&.join(',')}&subject=#{@fund.name}:", class: "dropdown-item" %>
                      </li>
                      <li>
                        <%= link_to "Check Access Rights" , check_access_rights_fund_path(@fund, create_missing: false), {class: "dropdown-item" }  %>
                      </li>

                      <li>
                        <%= button_to "Generate Tracking Numbers" , generate_tracking_numbers_fund_path(@fund), method: :post, class: "dropdown-item" , form_class: "deleteButton"  %>
                      </li>

                  </ul>
                </li>
              </div>
            <% end %>


            <% if @fund.entity.permissions.enable_units? %>
              <div class="dropdown-divider"></div>

              <%= link_to "Fund Unit Settings", fund_unit_settings_path(fund_id: @fund.id), {class: "dropdown-item" } %>

              <%= link_to "Fund Units", fund_units_path(fund_id: @fund.id, cols: :all), {class: "dropdown-item" } %>

              <%= link_to "View Stakeholders", investors_path(owner_id: @fund.id, owner_type: "Fund"), {class: "dropdown-item" }  if current_user.enable_investors %>
            <% end %>



        </div>
      </div>

      <% if policy(@fund).delete_all? && params[:delete_all].present? %>
        <div class="btn-group">
          <div class="dropdown">
            <button class="btn btn-outline-danger dropdown-toggle" type="button"
                    data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              Delete All
            </button>
            <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">

              <%
              delete_classes = ["AccessRight", "AccountEntry", "CapitalCommitment", "CapitalCall", "CapitalRemittance", "CapitalRemittancePayment", "CapitalDistribution", "CapitalDistributionPayment", "FundFormula", "PortfolioInvestment", "FundUnit", "FundUnitSetting", "AggregatePortfolioInvestment"].sort

              delete_classes.each do |class_name|
              %>

                <%= button_to class_name , delete_all_fund_path(@fund, type: class_name, authenticity_token: form_authenticity_token), {class: "dropdown-item", form_class: "deleteButton", data: {action: "click->confirm#popup" , turbo:false, msg: "Caution! Delete all #{class_name} for this fund? This is not reversible."} } %>

              <% end %>

          </div>
        </div>
      <% end %>


    <% end %>


  </div>

  <%= render "/funds/fund_details", fund: @fund %>
