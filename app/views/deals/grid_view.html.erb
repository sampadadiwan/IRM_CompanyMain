<%= render "/layouts/alerts" %>

<div class="d-sm-flex align-items-center justify-content-between mb-4" data-controller="nudge">
    <h1 class="h3 mb-0 text-gray-800">Deal Grid View</h1>
    <span>

        <%= render "investments/currency_form" %>

        <% if params[:all].blank? %>
            <%= link_to "All Investors", deal_path(id: @deal.id, grid_view: true, all:true), {class: "btn btn-primary"}  %>
        <% else %>
            <%= link_to "Not Declined", deal_path(id: @deal.id, grid_view: true), {class: "btn btn-primary"}  %>
        <% end %>

        <% if current_user.entity_id == @deal.entity_id %>
            <%= link_to "Add Investor", new_deal_investor_path("deal_investor[deal_id]": @deal.id, "deal_investor[entity_id]": current_user.entity_id) , {class: "btn btn-success"}%>
            <%= link_to "All Nudges", nudges_path , {class: "btn btn-primary"}%>
        <% end %>

        <% if !@deal.start_date.present?  %>
            <%= button_to "Start Deal", start_deal_deal_path(@deal), 
            {class: "btn btn-success", form_class: "deleteButton"} %> 
        <% end %>

        <a class="btn btn-success", hidden="hidden", data-action="click->nudge#newDealMsg">Send Message</a>
        <%= link_to new_nudge_path(), id: "new_nudge", hidden: true do %>
            <span>Loading...</span>
        <% end %>
        <%= link_to deal_path(id: @deal.id, grid_view: true, all:true, format: :xlsx), {class: "btn btn-success"} do %>
            <i class="fa-lg fa-regular fa-file-excel"></i> Download
        <% end %>

        <%= link_to deal_path(id: @deal.id, chart: true), {class: "btn btn-success"} do %>
            <i class="fas fa-chart-line"></i> Charts
        <% end %>


    </span>
</div>

<div id="deal_grid_div" class="table-responsive dropright">
    <table id="deal_grid_view" class="table table-bordered dataTable" >
        <thead>
            <tr>
                <th class="sticky-col first-col">Investor</th>
                <th>
                    Pre Money
                    (<%= @deal.currency %>)
                </th>
                <th>
                    Primary
                    (<%= @deal.currency %>)
                </th>
                <th>
                    Secondary
                    (<%= @deal.currency %>)
                </th>
                <% DealActivity.templates(@deal).each do |deal_activity| %>
                    <th> <%= deal_activity.title %> </th>
                <% end %>
                <th>Company Advisor</th>
                <th>Investor Advisor</th>
                
            </tr>
        </thead>
        <tbody>
            <%  @deal_investors = @deal.deal_investors.includes(:investor, :deal, :deal_activities)
                @deal_investors = @deal_investors.not_declined if params[:all].blank?
                @deal_investors.each do |deal_investor| %>

                <%= render "deals/grid_view_row", deal_investor: deal_investor %>
            <% end %>
        </tbody>
    </table>
</div>

<%= render "/deals/deal_details", deal: @deal, show_investors: "No" %>
